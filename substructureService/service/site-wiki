# This configuration file can go into a sites-allowed/sites-enabled
# setup, which works nicely with the default ubuntu nginx setup.  It
# uses hard-coded ports, as nginx doesn't support variables in
# configuration files--adjust these as needed, and proxy accordingly
# from your root server if this is part of a shared installation (or
# if you want to separate ssl termination from serving wiki content).

server {
    listen 8080 default_server;

    # Run all the mediawiki php codes.
    # with help from:
    # http://askubuntu.com/questions/134666/what-is-the-easiest-way-to-enable-php-on-nginx
    # https://www.nginx.com/resources/wiki/start/topics/recipes/mediawiki/

    # Note that we also host some static content from the mediawiki directory.
    # This is a little sketchy, but I think it's better than
    root /var/www/mediawiki;

    client_max_body_size 5m;
    client_body_timeout 60;

    location = /search {
      proxy_set_header   Host             $host:$server_port;
      proxy_set_header   X-Real-IP        $remote_addr;
      proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
      proxy_pass         http://localhost:8888; # Shouldn't be publicly accessible.
      proxy_redirect     default;

      break;
      # Break required to prevent additional processing by other location blocks.
    }

    location /substructure {
      autoindex off;
      index  index.html index.htm;
    }

    location / {
      autoindex off;
      try_files $uri $uri/ @rewrite;
    }

    location @rewrite {
      rewrite ^/(.*)$ /index.php?title=$1&$args;
    }

    location ^~ /maintenance/ {
      return 403;
    }

    location ~ \.php$ {
      include fastcgi_params;
      fastcgi_pass unix:/var/run/php5-fpm.sock;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
      try_files $uri /index.php;
      expires max;
      log_not_found off;
    }

    location = /_.gif {
      expires max;
      empty_gif;
    }

    location ^~ /cache/ {
      deny all;
    }

    location /dumps {
      root /var/www/mediawiki/local;
      autoindex on;
    }
  }

  # HTTPS server
  #
  #server {
  #    listen       443 ssl;
  #    server_name  localhost;

  #    ssl_certificate      cert.pem;
  #    ssl_certificate_key  cert.key;

  #    ssl_session_cache    shared:SSL:1m;
  #    ssl_session_timeout  5m;

  #    ssl_ciphers  HIGH:!aNULL:!MD5;
  #    ssl_prefer_server_ciphers  on;

  #    location / {
  #        root   html;
  #        index  index.html index.htm;
  #    }
  #}

}
